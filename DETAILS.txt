================================================================================
                            SRT2dvbSUB
         Convert SRT Subtitles to dvb Subtitles in MPEG-TS
================================================================================

DISCLAIMER
================================================================================

This project is an independent, open-source implementation with no affiliation
with, endorsement from, or connection to the DVB Project or the DVB
Organisation. The acronym "dvb" in this project refers exclusively to the dvb
(Digital Video Broadcasting) technology standard as defined in relevant
technical specifications. This tool implements the dvb subtitle specification
for interoperability purposes only. Use of the term "dvb" is for technical
reference and does not imply any official status or authorization from the DVB
Organisation.

================================================================================
1. OVERVIEW
================================================================================

srt2dvbsub is an attempt at a sophisticated command-line tool that converts
SRT (SubRip) subtitle files into dvb subtitle tracks 
and multiplexes them directly into MPEG-TS (Transport Stream) files.

This tool is essential for broadcasters, IPTV providers, and content
distribution networks that need to deliver compliant dvb subtitles embedded in
transport streams for television distribution or digital distribution platforms.

Key capabilities:
  • Convert SRT subtitle text to dvb bitmap subtitles
  • Support for ASS/SSA format with advanced rendering options
  • Multi-track subtitle support (up to 8 simultaneous tracks)
  • Somewhat professional quality text-to-bitmap rendering using Pango/Cairo
  • Direct MPEG-TS multiplexing without separate remuxing step
  • Multi-threaded rendering for high performance
  • Quality control (QC) verification of subtitle files
  • Comprehensive language code support (dvb 3-letter codes)
  • Full control over subtitle appearance (fonts, colors, sizing)


2. MOTIVATION & USE CASES
================================================================================

Traditional workflow limitations:
  • Most open source video editing tools cannot directly output dvb subtitles
  • Subtitles from SRT files must be manually converted to bitmap format
  • dvb subtitles are binary and cannot be edited in text editors
  • Post-production subtitle generation is labor-intensive

srt2dvbsub solves these problems by:
  • Automating SRT-to-dvb conversion in a single command
  • Supporting professional text rendering with full font control
  • Enabling batch processing for content archives
  • Integrating into automated encoding pipelines
  • Eliminating need for proprietary dvb authoring tools
  • Providing QC checks for subtitle file validity before encoding

Primary use cases:
  1. IPTV/OTT platforms: Delivering broadcast-compliant subtitles
  2. Archive digitization: Converting legacy subtitle formats
  3. Broadcast mastering: Multi-language subtitle preparation
  4. Content distribution: Quality-controlled subtitle delivery
  5. Automated encoding: Pipeline integration for batch processing


3. FEATURES
================================================================================

3.1 Subtitle Conversion
  ✓ SRT (SubRip) format parsing and conversion - ONLY format accepted
  ✓ ASS/SSA tag support within SRT files (evaluated and redered only with --ass flag)
  ✓ Multi-track subtitle processing
  ✓ Per-track language code assignment (dvb 3-letter ISO codes)
  ✓ Forced subtitle flag per track
  ✓ Hearing-impaired subtitle flag per track

3.2 Text Rendering
  ✓ Professional text rendering via Pango/Cairo
  ✓ Optional libass rendering for advanced ASS formatting
  ✓ Configurable font families and styles
  ✓ Dynamic font size calculation based on video resolution
  ✓ Manual font size override support
  ✓ Custom foreground, outline, and shadow colors
  ✓ Color validation and format conversion
  ✓ Advanced 9-position canvas positioning (top/center/bottom + left/center/right)
  ✓ Per-track margin control (percentage-based for resolution independence)
  ✓ Automatic text justification (left/center/right) matching position
  ✓ ASS/SSA alignment tag recognition ({\an<digit>}) for per-subtitle positioning

3.3 dvb Subtitle Generation
  ✓ MPEG-TS multiplexing with subtitle tracks
  ✓ Custom PID assignment with validation
  ✓ Manual bitrate control (MPEG-TS muxrate)
  ✓ dvb Page Composition Segment (PCS) generation
  ✓ Palette mode selection (EBU broadcast, broadcast, greyscale)
  ✓ Automatic dithering for color reduction
  ✓ Unsharp mask filter for text clarity (optional)
  ✓ Supersample anti-aliasing (SSAA) with configurable factors

3.4 Performance & Quality
  ✓ Multi-threaded rendering (configurable thread count)
  ✓ Per-track subtitle delay adjustment
  ✓ Global delay offset support
  ✓ Benchmark mode for performance analysis
  ✓ Quality control (QC) mode for subtitle validation
  ✓ Debug PNG output for visual inspection
  ✓ PNG-only mode for preview generation (no MPEG-TS encoding)
  ✓ Comprehensive debug logging

3.5 Compatibility
  ✓ FFmpeg 58.0+ integration
  ✓ Pango 1.52.1+ text rendering
  ✓ Cairo 1.18.0+ graphics
  ✓ Fontconfig 2.15.0+ font discovery
  ✓ libass 0.17.1+ (optional)
  ✓ POSIX-compliant systems (Linux, macOS, BSD)


4. QUICK START
================================================================================

4.1 Basic Usage
  # Convert a single English SRT file
  srt2dvbsub \
    --input video.ts \
    --output video_with_subs.ts \
    --srt subtitles.srt \
    --languages eng

4.2 Multiple Subtitle Tracks
  # Add English and German subtitles
  srt2dvbsub \
    --input video.ts \
    --output video_with_subs.ts \
    --srt eng_subs.srt,deu_subs.srt \
    --languages eng,deu

4.3 Custom Rendering Options
  # Use custom font and colors
  srt2dvbsub \
    --input video.ts \
    --output video_with_subs.ts \
    --srt subtitles.srt \
    --languages eng \
    --font "Open Sans" \
    --fontsize 36 \
    --fgcolor "#ffffff" \
    --outlinecolor "#000000"

4.4 With Timing Adjustments
  # Apply global delay and per-track delays
  srt2dvbsub \
    --input video.ts \
    --output video_with_subs.ts \
    --srt eng.srt,deu.srt \
    --languages eng,deu \
    --delay 100,200

4.5 Multiple Tracks of Same Language
  # Add English subtitles and English hearing-impaired subtitles
  # (both labeled as 'eng' but differentiated by flags)
  srt2dvbsub \
    --input video.ts \
    --output video_with_subs.ts \
    --srt eng_standard.srt,eng_hi.srt \
    --languages eng,eng \
    --hi 0,1

4.6 Quality Control Check Only
  # Validate subtitles without encoding
  srt2dvbsub \
    --qc-only \
    --srt subtitles.srt \
    --languages eng

4.7 Batch Encode Mode (directory tree orchestration)
  The built-in batch engine is a robust orchestration layer that allows srt2dvbsub
  to process entire directory trees of content without external scripting. It is
  designed for high-volume workflows where manual file-by-file processing is
  impractical.

  4.7.1 Core Workflow
    1. Recursively scans `--batch-input` for all files ending in `.ts`.
    2. For each file found, calculates its path relative to the input root.
    3. Creates the corresponding directory structure in `--batch-output`.
    4. Attempts to resolve subtitle files using configured templates (see 4.7.3).
    5. If subtitles are found, invokes the encoding engine for that file.
    6. If no subtitles are found, the file is skipped (unless configured otherwise).

  4.7.2 Required Arguments
    --batch-encode
        Activates the batch processing mode.
        
    --batch-input DIR
        The root directory containing source media. This directory is scanned
        recursively.
        
    --batch-output DIR
        The root directory where output files will be written. The internal
        structure of the input directory is mirrored here.
        
    --batch-srt DIR
        The root directory containing subtitle files. The engine looks for
        subtitles here first, expecting the same directory structure as the input.

  4.7.3 Subtitle Templates
    Templates define how the engine finds subtitles for a given video file.
    A template is a string in the format: "PATTERN|LANG_CODE"
    
    Variables:
      ${BASENAME} - The video filename without extension (e.g., "Movie.2024")
      ${SHOW}     - Detected show name (heuristic)
      ${SEASON}   - Detected season number (e.g., "S01")
      ${EPISODE}  - Detected episode number (e.g., "E01")
      
    Default Templates (Legacy Compatibility):
      1. "${BASENAME}.en.subtitles.srt|eng"
      2. "${BASENAME}.de.subtitles.srt|deu"
      3. "${BASENAME}.en.srt|eng"
      4. "${BASENAME}.de.srt|deu"
      
    Customizing Templates:
      Use `--batch-clear-templates` to remove defaults, then add your own
      with `--batch-template`.
      
      Example:
        --batch-clear-templates
        --batch-template "${BASENAME}.eng.srt|eng"
        --batch-template "${BASENAME}.fra.srt|fra"

  4.7.4 Resolution Logic
    For a video file "Movies/SciFi/SciFiMovie.ts", the engine searches in this order:
    
    1. Parallel Directory Search:
       Checks `--batch-srt/Movies/SciFi/` for files matching the templates.
       
    2. Side-by-Side Search:
       Checks `--batch-input/Movies/SciFi/` (alongside the video) for files
       matching the templates.
       
    The first match wins. This allows you to keep subtitles separate or
    colocated with the media.

  4.7.5 Operational Flags
    --batch-dry-run
        Prints the exact commands that would be executed to stdout without
        actually running the encoder or creating directories. Highly recommended
        for verifying your templates before a long run.

  4.7.6 Example Command
    srt2dvbsub \
      --batch-encode \
      --batch-input /media/master/HD-TV \
      --batch-output /media/output/HD-TV \
      --batch-srt /media/subs/HD-TV \
      --batch-template "${SHOW}_S${SEASON}_E${EPISODE}.en.srt|eng" \
      --batch-template "${SHOW}_S${SEASON}_E${EPISODE}.de.srt|deu" \
      --delay 100 --ssaa 6 --font "Open Sans" --font-style "Light" --font-size 50 \
      --margin-bottom 7.5 --overwrite --no-unsharp


5. COMMAND-LINE REFERENCE
================================================================================

5.1 Required Arguments
  -I, --input FILE
      Input media file path
      • MPEG-TS, MP4, MKV, or other FFmpeg-supported format
      • Used to detect video dimensions and stream information
      • Path must be < 4096 bytes (PATH_MAX)
      
  -o, --output FILE
      Output file path (MPEG-TS)
      • Will contain original streams plus dvb subtitle tracks
      • Existing file will be overwritten
      • Path must be < 4096 bytes (PATH_MAX)
      
  -s, --srt FILES
      Comma-separated list of SRT subtitle files
      • Format: file1.srt,file2.srt,file3.srt
      • ONLY SRT (SubRip) format is accepted
      • SRT files MAY contain ASS/SSA formatting tags (e.g., {\an8}, {\c&H...})
      • ASS tags within SRT files are ONLY evaluated and respected when --ass flag is used
      • If a true/native ASS or SSA file is provided, the program will FAIL
      • Each file corresponds to one subtitle track
      • Paths must be < 4096 bytes (PATH_MAX)
      • Files must be valid SubRip format
      • Use without argument and next positional arg as auto-correct fallback
      
  -l, --languages CODES
      Comma-separated list of dvb 3-letter language codes
      • Format: eng,deu,fra,etc.
      • Must have same count as --srt files
      • Use --help to see complete list of valid codes
      • Duplicate language codes allowed but MUST have different flags
      • Example: "eng,eng,deu" is allowed ONLY if tracks 0 and 1 have
        different --forced or --hi settings (see section 5.5)
      • Invalid: "--languages eng,eng --hi 0,0" (both same lang + same flags)
      • Valid: "--languages eng,eng --hi 0,1" (same lang + different flags)


5.2 Rendering & Appearance Options
  --font FONTNAME
      Font family name (default: DejaVu Sans)
      • System font name as understood by Fontconfig
      • Examples: "Arial", "Times New Roman", "Liberation Sans"
      • Use --list-fonts to display available fonts
      • Applies to all SRT tracks (per-track selection: planned feature)
      
  --font-style STYLE
      Font style variant (e.g., Bold, Italic, Light)
      • Examples: "Bold", "Italic", "Bold Italic", "Light"
      • Combined with font family: "Arial Bold"
      • Optional; if not specified uses font family default
      
  --fontsize N
      Fixed font size in pixels (overrides dynamic sizing)
      • Range: 8 to 72 (reasonable limits for TV viewing)
      • Default behavior: size calculated from video resolution
      • Use when dynamic sizing produces unsatisfactory results
      • Too small: text unreadable; Too large: text clipped
      
  --fgcolor #RRGGBB
      Text foreground color (default: white)
      • Format: #RRGGBB hexadecimal (e.g., #ffffff for white)
      • Must use quotes on shell: "--fgcolor '#00ff00'"
      • Examples:
        - #ffffff = white (default)
        - #000000 = black
        - #ffff00 = yellow
        - #00ff00 = green
      
  --outlinecolor #RRGGBB
      Text outline/stroke color (default: gray)
      • Format: #RRGGBB hexadecimal
      • Used for text edge definition and readability
      • Examples:
        - #000000 = black outline (high contrast)
        - #808080 = gray (subtle outline)
      
  --shadowcolor #[AA]RRGGBB
      Shadow color with optional alpha channel
      • Format: #RRGGBB or #AARRGGBB (alpha optional)
      • Alpha: 00 (transparent) to FF (opaque)
      • Examples:
        - #00000080 = semi-transparent black shadow
        - #ff0000ff = opaque red shadow
      • Shadow adds depth to text

  --bg-color #RRGGBB
      Background color for subtitle text box (optional)
      • Format: #RRGGBB hexadecimal (RGB only, always opaque)
      • When not specified: no background (transparent)
      • Examples:
        - #000000 = black background
        - #ffffff = white background
        - #404040 = dark gray background
      • Background fills entire subtitle text bounding box with equal padding

  --sub-position POSITION
      Subtitle position on canvas (default: bottom-center)
      • Supported positions: top-left, top-center, top-right,
                          middle-left, middle-center, middle-right,
                          bottom-left, bottom-center, bottom-right
      • Format: position name (e.g., "--sub-position top-left")
      • Default: bottom-center (traditional TV placement)
      • Examples:
        - "--sub-position bottom-center" = standard TV position (default)
        - "--sub-position top-left" = corner positioning
        - "--sub-position middle-right" = side positioning
      • Text alignment within bounding box matches position:
        - LEFT positions: text left-justified
        - CENTER positions: text center-justified
        - RIGHT positions: text right-justified
      • Combines with margin flags for precise placement
      • Useful for avoiding overlaps with on-screen graphics or logos
      
  --margin-top PERCENT
      Top margin for subtitle placement (default: 3.5%)
      • Format: floating-point percentage (0.0 to 50.0)
      • Applies to: top-left, top-center, top-right positions
      • Default: 3.5% of canvas height
      • Example: "--sub-position top-left --margin-top 5.0" places subtitle 5% from top
      
  --margin-left PERCENT
      Left margin for subtitle placement (default: 3.5%)
      • Format: floating-point percentage (0.0 to 50.0)
      • Applies to: top-left, center-left, bottom-left positions
      • Default: 3.5% of canvas width
      • Example: "--sub-position top-left --margin-left 3.0" places subtitle 3% from left
      
  --margin-bottom PERCENT
      Bottom margin for subtitle placement (default: 3.5%)
      • Format: floating-point percentage (0.0 to 50.0)
      • Applies to: bottom-left, bottom-center, bottom-right positions
      • Default: 3.5% of canvas height
      • Example: "--sub-position bottom-center --margin-bottom 5.0" places subtitle 5% from bottom
      
  --margin-right PERCENT
      Right margin for subtitle placement (default: 3.5%)
      • Format: floating-point percentage (0.0 to 50.0)
      • Applies to: top-right, center-right, bottom-right positions
      • Default: 3.5% of canvas width
      • Example: "--sub-position bottom-right --margin-right 3.5" places subtitle 3.5% from right
      
  ASS/SSA Alignment Tags
      Automatic positioning via {\an<digit>} tags in subtitle text
      • Format: {\an<digit>} where digit is 1-9 or 0
      • Mapping (numeric keypad layout):
        - {\an7} = top-left, {\an8} = top-center, {\an9} = top-right
        - {\an4} = center-left, {\an5} = center, {\an6} = center-right
        - {\an1} = bottom-left, {\an2} = bottom-center, {\an3} = bottom-right
        - {\an0} = use CLI default
      • Tags override CLI positioning on per-subtitle basis
      • Tags are automatically removed before rendering (never visible)
      • Useful for: subtitles extracted from MPEG-2 closed captions
      • Processing priority (highest to lowest):
        1. ASS tags in subtitle text
        2. CLI --sub-position and --margin-* flags
        3. Default: bottom-center with 3.5% margins


5.3 MPEG-TS Stream Options
  --pid PID[,PID2,...]
      Custom PIDs (Program IDs) for subtitle tracks
      • Single value: auto-increment for each track
        Format: "--pid 150"  (150, 151, 152, ... for multiple tracks)
      • Multiple values: explicit PID per track
        Format: "--pid 150,151,200"  (each track gets specific PID)
      • Valid range: 32-8186 (excludes reserved 0-31)
      • Default behavior (no --pid): system assigns PID after audio tracks
      • Useful for: ensuring subtitle track placement, matching DVB specs
      • Examples:
        - "--pid 150": First track 150, second 151, third 152, etc.
        - "--pid 150,160,170": Explicit assignment for 3 tracks
      • Validation: no duplicates allowed, no conflicts with A/V PIDs
      
  --ts-bitrate BITRATE
      Override MPEG-TS output bitrate (muxrate) in bits per second
      • Bitrate in bps: "--ts-bitrate 12000000" (12 Mbps)
      • Valid range: 100,000 to 1,000,000,000 bps
      • Default behavior (no --ts-bitrate): auto-detect from input file
      • Auto-detection: enhanced with extended probe (10 MiB, 30 seconds)
      • Useful for: matching specific broadcast or streaming requirements
      • Common values:
        - 8000000 (8 Mbps): Streaming/limited bandwidth
        - 12000000 (12 Mbps): Standard broadcast
        - 20000000 (20 Mbps): High bitrate/UHD
      • When specified: overrides detected bitrate from input file
      • Affects: final output file size and timing of subtitle packets
      • Note: If bitrate too low, muxer may add stuffing to maintain sync


5.4 dvb Subtitle Options
  --palette MODE
      Palette mode for color reduction
      • Modes: "ebu-broadcast", "broadcast", "greyscale"
      • ebu-broadcast: EBU R207 standard colors (recommended for broadcast)
      • broadcast: Broadcast standard palette
      • greyscale: Grayscale palette
      • Default: ebu-broadcast
      • Affects how colors are dithered to dvb palette
      
  --ssaa N
      Supersample anti-aliasing factor (1..24)
      • Default: 4 (render at 4x internal resolution, then downsample)
      • Higher values: smoother text, slower rendering
      • Lower values: faster rendering, possibly jagged text
      • Reasonable range: 2-8 for most content
      • Use --no-unsharp to disable unsharp filter on downsampled result
      
  --no-unsharp
      Disable unsharp mask filter on rendered subtitles
      • Unsharp mask sharpens text after anti-aliasing
      • Disabling speeds up rendering but may blur text slightly
      • Use if rendering performance is critical


5.4 dvb Subtitle Options
  --palette MODE
      Palette mode for color reduction
      • Modes: "ebu-broadcast", "broadcast", "greyscale"
      • ebu-broadcast: EBU R207 standard colors (recommended for broadcast)
      • broadcast: Broadcast standard palette
      • greyscale: Grayscale palette
      • Default: ebu-broadcast
      • Affects how colors are dithered to dvb palette
      
  --ssaa N
      Supersample anti-aliasing factor (1..24)
      • Default: 4 (render at 4x internal resolution, then downsample)
      • Higher values: smoother text, slower rendering
      • Lower values: faster rendering, possibly jagged text
      • Reasonable range: 2-8 for most content
      • Use --no-unsharp to disable unsharp filter on downsampled result
      
  --no-unsharp
      Disable unsharp mask filter on rendered subtitles
      • Unsharp mask sharpens text after anti-aliasing
      • Disabling speeds up rendering but may blur text slightly
      • Use if rendering performance is critical


5.5 Timing & Delay Options
  --delay MS[,MS2,...]
      Subtitle delay in milliseconds
      • Single value: applied to all tracks
        Format: "--delay 100"  (100 ms delay for all tracks)
      • Per-track values: comma-separated for each track
        Format: "--delay 0,100,200"  (track 1: 0ms, track 2: 100ms, etc.)
      • Positive: delay subtitles (appear later)
      • Negative: advance subtitles (appear earlier)
      • Range: -5000 to +5000 ms (reasonable limits)
      • Applied before dvb encoding


5.6 Subtitle Attributes
  --forced FLAGS
      Comma-separated forced flags per track (default: all 0)
      • Format: "0,1,0" where 1=forced, 0=not forced
      • One value per track in --srt order
      • If fewer values than tracks, missing tracks default to 0
      • Examples:
        - "--forced 1": First track is forced, rest default to 0
        - "--forced 0,1": First not forced, second forced
        - "--forced 1,1,0": First two forced, third not forced
      • Forced subtitles appear only when default audio language differs
      • Typical use: signs and text that must always be visible
      • Note: Duplicate language codes REQUIRE different forced/hi flags
      
  --hi FLAGS
      Comma-separated hearing-impaired flags per track (default: all 0)
      • Format: "0,0,1" where 1=hearing-impaired, 0=regular
      • One value per track in --srt order
      • If fewer values than tracks, missing tracks default to 0
      • Examples:
        - "--hi 1": First track is hearing-impaired, rest default to 0
        - "--hi 0,0,1": Only third track is hearing-impaired
        - "--hi 1,1,0": First two are hearing-impaired, third is regular
      • Hearing-impaired subtitles include sound descriptions
      • Affects dvb subtitle page composition and signaling
      • Example content: "[DOOR OPENS]" or "[MUSIC PLAYING]"
      • Note: Duplicate language codes REQUIRE different forced/hi flags


5.7 Performance & Threading
  --render-threads N
      Parallel rendering workers (default: 0 = single-threaded)
      • 0: Synchronous rendering (no worker pool)
      • 1-N: Use N background threads for parallel rendering
      • Auto-capped at 2x CPU count (or 4 if CPU count unknown)
      • Larger values: faster rendering on multi-core systems
      • Trade-off: memory usage increases with thread count
      • Default (0) is safe and simpler; increase for large batches
      
  --enc-threads N
      Encoder thread count for FFmpeg (default: 0 = auto)
      • 0: Auto-detect based on CPU count
      • 1-N: Use N threads for video/audio encoding
      • Shared with FFmpeg encoding, affects H.264/H.265 speeds
      • Auto-capped at 2x CPU count (or 4 if CPU count unknown)
      • Set this if baseline encoding is a bottleneck


5.8 Debugging & Quality Control
  --qc-only
      Run subtitle file quality checks only (no MPEG-TS generation)
      • Validates SRT files for syntax errors
      • Checks timing continuity and overlaps
      • Outputs report to qc_log.txt
      • Useful for validating subtitle quality before full encode
      • Exit code: 0 on success, 1 on validation failure
      
  --debug N
      Set debug verbosity level (0=quiet, 1=errors, 2=verbose)
      • 0: Suppress all debug output (errors only)
      • 1: Show warnings and key info (default)
      • 2: Verbose diagnostic information
      • 3: Ultra-verbose (for development/troubleshooting)
      • Output goes to stderr; does not affect MPEG-TS output
      
  --bench
      Enable micro-benchmark timing output
      • Measures rendering, encoding, and muxing times
      • Output to stderr with per-track statistics
      • Useful for performance analysis and optimization
      • Does not affect output quality or format
      
  --png-dir PATH
      Output debug PNG images to directory
      • Saves rendered subtitle bitmaps as PNG files
      • One PNG per subtitle event, named sequentially
      • PATH must be writable; falls back to /tmp if needed
      • Useful for visual inspection and debugging
      • Can consume significant disk space for long videos

  --png-only
      Output PNG files only (no MPEG-TS file generated)
      • Renders all subtitles to PNG images in --png-dir directory
      • No MPEG-TS container file is produced
      • Useful for visual quality control and subtitle inspection
      • --png-dir MUST be specified when using this flag
      • Each subtitle event saved as separate PNG file
      • Faster than full MPEG-TS encoding (no muxing phase)
      • Example: --png-only --png-dir "./preview_pngs" renders subtitles for visual review


5.9 Advanced Options
  --ass
      Enable libass subtitle rendering (requires --enable-ass build)
      • Switches from Pango rendering to libass
      • ASS format supports more formatting (italic, color per char, etc.)
      • Requires libass 0.17.1+ to be available at build time
      • May produce different visual results than Pango rendering
      • Incompatible with some Pango-specific options
      
  --list-fonts
      List available font families and styles
      • Requires Fontconfig support at build time
      • Output shows fonts installed on system
      • Format: font_family [style1] [style2] ...
      • Use font names in output with --font option
      • Exits after printing (does not process subtitles)
      
  --license
      Show license information and exit
      • Displays Personal Use License terms
      • Shows commercial licensing contact information
      • Warranty disclaimer


5.10 Batch Processing Options
  --batch-encode
      Activate batch processing mode for directory tree processing
      • Recursively scans --batch-input for .ts files
      • Mirrors directory structure to --batch-output
      • Resolves subtitles using --batch-template patterns
      • Must be accompanied by --batch-input, --batch-output, --batch-srt
      • All other CLI flags (font, colors, delays, etc.) apply to each file
      • Cannot be combined with --input and --output (mutually exclusive)
      • Exit code: 0 if all files processed successfully, 1 on any error
      
  --batch-input DIR
      Root directory to scan for .ts files (recursive, required with --batch-encode)
      • Directory must exist and be readable
      • All .ts files found recursively are processed
      • Directory structure is preserved in --batch-output
      • Example: "/media/movies" scans /media/movies and all subdirectories
      
  --batch-output DIR
      Root directory for output files (created if necessary, required with --batch-encode)
      • Output directory structure mirrors --batch-input
      • Created automatically if missing
      • Must be writable by the running user
      • Example: If input is "/media/movies/Sci-Fi/Film.ts", output will be
        "/media/output/Sci-Fi/Film.ts" relative to --batch-output
      
  --batch-srt DIR
      Root directory containing subtitle files (required with --batch-encode)
      • Engine looks for subtitles here first, using input-relative paths
      • Falls back to searching alongside .ts files if not found
      • Directory structure should mirror --batch-input for best results
      • Example: "/media/subtitles" will look in "/media/subtitles/Sci-Fi/" for
        subtitles matching a file in "input/Sci-Fi/"
      
  --batch-template "PATTERN|LANG"
      Subtitle filename pattern with language code (repeatable, optional with --batch-encode)
      • Format: "PATTERN|LANG_CODE" where LANG_CODE is 3-letter dvb code
      • Available variables in PATTERN:
        - ${BASENAME}: Video filename without extension (e.g., "Movie.2024")
        - ${SHOW}: Detected show name (heuristic parsing)
        - ${SEASON}: Detected season number (e.g., "S01")
        - ${EPISODE}: Detected episode number (e.g., "E01")
      • Multiple templates: repeatable flag, first match wins
      • Examples:
        - "--batch-template '${BASENAME}.eng.srt|eng'" matches "Movie.2024.eng.srt"
        - "--batch-template '${SHOW}_S${SEASON}_E${EPISODE}.de.srt|deu'" matches "Show_S01_E01.de.srt"
      • Default templates (if none specified):
        1. "${BASENAME}.en.subtitles.srt|eng"
        2. "${BASENAME}.de.subtitles.srt|deu"
        3. "${BASENAME}.en.srt|eng"
        4. "${BASENAME}.de.srt|deu"
      
  --batch-clear-templates
      Remove all default templates before adding custom ones
      • Use before --batch-template to replace defaults with custom patterns
      • Without this, defaults are used alongside any custom templates
      • Example: "--batch-clear-templates --batch-template 'custom.srt|eng'"
      • Useful for avoiding conflicts with legacy naming conventions
      
  --batch-dry-run
      Print planned encoder commands without executing them
      • Outputs to stdout exactly what would be run for each file
      • No files are created, no encoding happens
      • Useful for verifying templates and argument forwarding before long runs
      • Recommended: always run with --batch-dry-run first
      • Shows: input file, subtitle resolution, output file, complete command line
    


5.11 Help & Version
  -h, --help, -?
      Show help message and exit
      • Displays all available options and language codes
      • Language codes formatted for terminal width
      • Shows examples of commonly used options
      
  (Version information)
      Build git hash, tag, and build date in output
      • Embedded at compile time via GIT_VERSION, GIT_COMMIT, GIT_DATE
      • Useful for troubleshooting version-related issues


6. CONFIGURATION OPTIONS
================================================================================

6.1 Build-Time Configuration
  These options are set during ./configure and affect the binary.

  --enable-ass
      Enable ASS/SSA format rendering with libass
      • Requires: libass 0.17.1 or later
      • When enabled: --ass flag available at runtime
      • Adds: Advanced SubStation Alpha format support
      • Slower than Pango but supports more formatting
      • Default: disabled (SRT and Pango rendering only)
      
  --disable-thread-safe-mux
      Disable mutex guard around MPEG-TS multiplexing
      • By default: mutex ensures thread-safe mux writes
      • When disabled: Faster muxing but requires single-threaded mux
      • Use only if you understand single-threaded implications
      • Affects ENABLE_THREAD_SAFE_MUX compile flag
      • Default: enabled (mutex guard active)

6.2 Runtime Configuration
  No runtime configuration files; all options via command-line flags.
  
  Recommended patterns for common scenarios:

  Broadcast Quality (EBU Standard):
    --palette ebu-broadcast \
    --font "DejaVu Sans" \
    --fontsize 36 \
    --fgcolor "#ffffff" \
    --outlinecolor "#000000" \
    --ssaa 4

  Web/Streaming Quality (faster):
    --palette broadcast \
    --font "Arial" \
    --fontsize 32 \
    --fgcolor "#ffffff" \
    --outlinecolor "#000000" \
    --ssaa 2 \
    --no-unsharp

  High Performance (minimal rendering):
    --render-threads 0 \
    --ssaa 2 \
    --no-unsharp

  Batch Processing (with parallelism):
    --render-threads 4 \
    --enc-threads 4 \
    --bench


7. ISO 639-2 LANGUAGE CODES
================================================================================

srt2dvbsub supports a subset of the standard 3-letter ISO 639-2 language codes.
Common codes include:

  eng  English / English           fin  Finnish / Suomi              heb  Hebrew / עברית               pan  Punjabi / ਪੰਜਾਬੀ
  deu  German / Deutsch            pol  Polish / Polski              ara  Arabic / العربية             urd  Urdu / اردو
  fra  French / Français           ces  Czech / Čeština              tur  Turkish / Türkçe             vie  Vietnamese / Tiếng Việt
  spa  Spanish / Español           slk  Slovak / Slovenčina          ell  Greek / Ελληνικά             tha  Thai / ไทย
  ita  Italian / Italiano          slv  Slovenian / Slovenščina      cat  Catalan / Català             ind  Indonesian / Bahasa Indonesia
  por  Portuguese / Português      hrv  Croatian / Hrvatski          gle  Irish / Gaeilge              msa  Malay / Bahasa Melayu
  rus  Russian / Русский           ron  Romanian / Română            eus  Basque / Euskara             sin  Sinhala / සිංහල
  jpn  Japanese / 日本語            bul  Bulgarian / Български        glg  Galician / Galego            khm  Khmer / ភាសាខ្មែរ
  zho  Chinese / 中文               ukr  Ukrainian / Українська       srp  Serbian / Српски             lao  Lao / ລາວ
  kor  Korean / 한국어               bel  Belarusian / Беларуская      mkd  Macedonian / Македонски      mon  Mongolian / Монгол
  nld  Dutch / Nederlands          est  Estonian / Eesti             alb  Albanian / Shqip             fas  Persian / فارسی
  swe  Swedish / Svenska           lav  Latvian / Latviešu           hin  Hindi / हिन्दी
  dan  Danish / Dansk              lit  Lithuanian / Lietuvių        tam  Tamil / தமிழ்
  nor  Norwegian / Norsk           hun  Hungarian / Magyar           tel  Telugu / తెలుగు


8. EXAMPLES
================================================================================

8.1 Basic Multi-Language Conversion
  srt2dvbsub \
    --input input.ts \
    --output output.ts \
    --srt english.srt,german.srt,french.srt \
    --languages eng,deu,fra

8.2 With Custom Fonts and Colors
  srt2dvbsub \
    --input video.ts \
    --output video_styled.ts \
    --srt subtitles.srt \
    --languages eng \
    --font "Liberation Sans" \
    --fontsize 40 \
    --fgcolor "#ffffff" \
    --outlinecolor "#000000" \
    --shadowcolor "#00000080"

8.3 With Per-Track Delays
  # Track 1: no delay, Track 2: 100ms delay, Track 3: 200ms delay
  srt2dvbsub \
    --input input.ts \
    --output output.ts \
    --srt track1.srt,track2.srt,track3.srt \
    --languages eng,spa,fra \
    --delay 0,100,200

8.4 Hearing-Impaired and Forced Subtitles
  srt2dvbsub \
    --input input.ts \
    --output output.ts \
    --srt sdh.srt,forced.srt \
    --languages eng,eng \
    --hi 1 \
    --forced 1

8.5 Quality Control Check
  srt2dvbsub \
    --qc-only \
    --srt subtitles.srt \
    --languages eng
  
  # Output written to qc_log.txt

8.6 High Performance Batch Processing
  srt2dvbsub \
    --input batch_video.ts \
    --output batch_output.ts \
    --srt subs.srt \
    --languages eng \
    --render-threads 8 \
    --enc-threads 8 \
    --ssaa 2 \
    --no-unsharp \
    --bench

8.7 ASS Format Support (when built with --enable-ass)
  srt2dvbsub \
    --input input.ts \
    --output output.ts \
    --srt subtitles.ass \
    --languages eng \
    --ass

8.8 Debug PNG Output
  srt2dvbsub \
    --input input.ts \
    --output output.ts \
    --srt subtitles.srt \
    --languages eng \
    --png-dir ./debug_pngs \
    --debug 2

8.9 List Available Fonts
  srt2dvbsub --list-fonts

8.10 Show Help with Language Codes
  srt2dvbsub --help


9. OUTPUT & FILES
================================================================================

9.1 Main Output
  • MPEG-TS file specified via --output
    - Contains original video/audio streams
    - dvb subtitle tracks multiplexed in
    - Ready for broadcast, Blu-ray, or OTT distribution

9.2 Quality Control Report (with --qc-only)
  • qc_log.txt in current directory
    - Subtitle syntax validation results
    - Timing continuity checks
    - Overlap detection
    - Summary pass/fail status

9.3 Debug Output (with --png-dir)
  • PNG files in specified directory
    - One file per subtitle event
    - Named sequentially (e.g., 00000000.png, 00000001.png)
    - Show rendered subtitle bitmap before dvb encoding
    - Useful for visual inspection of rendering quality

9.4 Benchmark Results (with --bench)
  • Micro-timing statistics on stderr
    - Parse time for SRT file
    - Per-track rendering times
    - Encoding times
    - Muxing times
    - Useful for performance analysis


10. PERFORMANCE & TUNING
================================================================================

10.1 Rendering Performance
  • --render-threads 0 (default, fastest for single-track)
    Single-threaded rendering, minimal context switching
    
  • --render-threads N (N = 2-8, recommended for multi-track)
    Parallel rendering of subtitle events
    Best when N matches or is slightly more than CPU count
    
  • --ssaa 2 (fast) vs --ssaa 4 (default) vs --ssaa 8 (quality)
    Lower SSAA = faster rendering but jagged text
    Higher SSAA = smoother text but slower rendering
    
  • --no-unsharp (saves ~10-15% rendering time)
    Disables unsharp filter after anti-aliasing
    Small visual impact on most content

10.2 Memory Usage
  • Scales with render thread count
    Each thread needs ~50-100MB for working buffers
    
  • Scales with SSAA factor
    Higher SSAA = larger internal buffers
    
  • Scales with video resolution
    1920x1080: ~200MB per thread
    3840x2160: ~800MB per thread
    
  • Recommended: Allocate 2GB+ for multi-track 4K encoding

10.3 Typical Benchmarks (on 8-core system)
  • Single English track, 1080p:
    - Serial mode: ~2x realtime
    - --render-threads 4: ~1.5x realtime
    
  • Three language tracks, 1080p:
    - Serial mode: ~6x realtime
    - --render-threads 4: ~2x realtime
    
  • 4K content:
    - Serial: ~8-10x realtime
    - --render-threads 8: ~3-4x realtime
    
  • Benchmarks vary by: CPU speed, font complexity, text density,
    video resolution, SSAA factor


11. TROUBLESHOOTING
================================================================================

11.1 Common Issues

  Q: "Out of memory" error
  A: Reduce --render-threads or lower --ssaa value
     Check available RAM: free -h or top
     
  Q: Text is blurry or jagged
  A: Increase --ssaa (try 6 or 8 instead of default 4)
     Or use --font with cleaner font family
     
  Q: Subtitles don't appear in output
  A: Verify --languages codes match input SRT count
     Check qc_log.txt for parsing errors (run --qc-only)
     Verify video dimensions detected correctly (--debug 2)
     
  Q: Colors look wrong or washed out
  A: Try different --palette mode (ebu-broadcast vs broadcast vs web)
     Check --fgcolor and --outlinecolor are correctly specified
     Verify --bg-color is set correctly if using backgrounds

     
  Q: Very slow rendering
  A: Reduce --ssaa or enable --no-unsharp
     Check system load (other processes consuming CPU/RAM)
     Increase --render-threads on multi-core systems
     
  Q: Font not found
  A: Run --list-fonts to see available fonts on system
     Font names are case-sensitive
     Use exact name from font listing output
     
  Q: "Font listing requires Fontconfig support"
  A: Rebuild with Fontconfig development libraries
     Or manually check system fonts in /usr/share/fonts
     
  Q: "Path exceeds PATH_MAX"
  A: Use shorter paths or relative paths
     PATH_MAX is typically 4096 bytes on POSIX systems

11.2 Debug Mode
  Use --debug 2 or --debug 3 for diagnostic information:
  
  srt2dvbsub \
    --input input.ts \
    --output output.ts \
    --srt subs.srt \
    --languages eng \
    --debug 2 2>&1 | tee debug.log

11.3 Benchmarking
  Use --bench for performance analysis:
  
  srt2dvbsub \
    --input input.ts \
    --output output.ts \
    --srt subs.srt \
    --languages eng \
    --bench 2>&1 | tee bench.log

11.4 Visual Inspection
  Use --png-dir to save debug PNG files:
  
  srt2dvbsub \
    --input input.ts \
    --output output.ts \
    --srt subs.srt \
    --languages eng \
    --png-dir ./pngs


12. LICENSE & SUPPORT
================================================================================

12.1 Personal Use License
  srt2dvbsub is licensed under a Personal Use License:
  
  ✓ Free for personal, educational, and non-commercial use
  ✓ Free to modify for personal projects
  ✓ Source code available for inspection
  
  ✗ Commercial use requires a Commercial License
  ✗ Cannot be sold or used in profit-generating business
  ✗ Cannot be included in commercial products without license
  
  See --license flag for full license terms.

12.2 Commercial Licensing
  Commercial use (IPTV, broadcast, SaaS, etc.) requires:
  • Paid Commercial License from copyright holder
  • Contact: license@capsaworks-project.de
  • Website: www.capsaworks-project.de

12.3 Copyright
  Copyright (c) 2025 Mark E. Rosche, Capsaworks Project
  All rights reserved.

12.4 Support & Issues
  Report bugs and request features at:
  • GitHub Issues: [repository URL]
  • Email: bugs@capsaworks-project.de
  • For licensing: license@capsaworks-project.de


13. TECHNICAL DETAILS
================================================================================

13.1 Architecture
  • CLI parsing: getopt_long for argument handling
  • SRT parsing: Custom robust recursive descent parser (srt_parser.c)
  • Text rendering: Pango + Cairo for high-quality bitmap output
  • dvb encoding: FFmpeg-integrated dvb subtitle encoder
  • Multiplexing: Direct MPEG-TS mux with FFmpeg
  • Threading: Worker pool for parallel subtitle rendering
  • Queue: Lock-free queue for subtitle event batching
  • Parser robustness: UTF-8 sanitization, timestamp validation, duplicate ID detection

13.2 Subtitle Rendering Pipeline
  1. Parse SRT file (srt_parser.c) with robustness enhancements
  2. Validate subtitle timing and content
  3. Render text to intermediate bitmap (Pango/Cairo or libass)
  4. Dither bitmap to dvb palette
  5. Generate dvb subtitle segments (Page Composition Segment)
  6. Encode into dvb subtitle packets
  7. Multiplex into MPEG-TS output

13.3 Video Stream Handling
  • Input: FFmpeg probes video dimensions and frame rate
  • Font scaling: Font size calculated from video resolution
  • Output: MPEG-TS with video, audio, and dvb subtitle tracks
  • Clock reference: PCR (Program Clock Reference) maintained

13.4 Performance Optimizations
  • Worker thread pool: Parallel subtitle rendering
  • Memory pooling: Pre-allocated buffers reused across renders
  • Lock-free queues: Minimize thread synchronization overhead
  • Dithering cache: Pre-computed dither patterns
  • Bitmap caching: Re-use unchanged subtitles


14. APPENDIX: DEPENDENCIES
================================================================================

Minimum Versions:
  • C11 compiler (GCC 5.0+, Clang 3.8+)
  • FFmpeg: libavformat 58.0, libavcodec 58.0, libavutil 56.0, libswscale 5.0
  • Pango: 1.52.1
  • Cairo: 1.18.0
  • Fontconfig: 2.15.0
  • libass: 0.17.1 (optional, for --enable-ass)

Installation Examples:

  Ubuntu/Debian:
    sudo apt-get install libavformat-dev libavcodec-dev libavutil-dev \
      libswscale-dev libpango1.0-dev libcairo2-dev libfontconfig1-dev \
      libass-dev pkg-config autotools-dev

  Fedora/RHEL/CentOS:
    sudo dnf install ffmpeg-devel pango-devel cairo-devel \
      fontconfig-devel libass-devel pkg-config autotools

  macOS (with Homebrew):
    brew install ffmpeg pango cairo fontconfig libass pkg-config
    brew install autoconf automake

  FreeBSD:
    pkg install ffmpeg pango cairo fontconfig libass pkgconf autotools


================================================================================
End of DETAILS.txt
For more information, run: srt2dvbsub --help
================================================================================
